<!doctype html><html lang=en><head><meta charset=utf-8><title>Slack Bots for Work</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=generator content="Hugo 0.69.0"><link href rel=alternate type=application/rss+xml title="Neil Grogan"><link href=../css/bootstrap.min.css rel=stylesheet><link href=../css/hc.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css rel=stylesheet></head><body><div class=nav-toggle><i class="fa fa-bars fa-2x"></i>Herring Cove</div><div id=wrapper><div class="navbar navbar-default" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a href=../><p class=navbar-brand>Neil Grogan</p></a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul></div></div></div><div id=sidebar-wrapper><ul class=sidebar-nav><img src><li class=sidebar-brand><a href=../><h1 class=brand>Neil Grogan</h1></a><h3>My home on the internet</h3></li><hr><hr><div id=social-wrapper></div></ul></div><div class=container><div id=article><div class=article-title>Slack Bots for Work</div><p class=meta><small>&nbsp;<i class="fa fa-calendar-o"></i> 2017-02-16</small></p><hr><div class=post><p>In a previous post, I mentioned how I get notified of the <a href=../rest-menu>restaurant menu</a> via a Ruby script. Recently I&rsquo;ve moved to a totally different product area and the main communication channel we use is <a href=https://www.slack.com>Slack</a>. Naturally enough, I ported the Ruby code I wrote, and it now posts the menu every day to our Slack channel.</p><p>This also got me thinking of what other information would be handy to have. I scouted around for ideas and came up with an obvious one: reminder of the bus times to and from the office. So here&rsquo;s my bus times notification slack bot:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#75715e>#!/usr/bin/env ruby</span>
<span style=color:#75715e>#Encoding: UTF-8</span>
require <span style=color:#e6db74>&#39;nokogiri&#39;</span>
require <span style=color:#e6db74>&#39;json&#39;</span>
require <span style=color:#e6db74>&#39;net/http&#39;</span>
require <span style=color:#e6db74>&#39;open-uri&#39;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>notify_slack</span>(text)
    webhook_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#75715e># TODO: Insert yours here</span>
    payload <span style=color:#f92672>=</span> {
        <span style=color:#75715e>#:channel =&gt; channel,</span>
        <span style=color:#75715e>#:username =&gt; username,</span>
        <span style=color:#e6db74>:text</span> <span style=color:#f92672>=&gt;</span> text
        <span style=color:#75715e>#:icon_url =&gt; image</span>
    }<span style=color:#f92672>.</span>to_json
    cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;curl -X POST --data-urlencode &#39;payload=</span><span style=color:#e6db74>#{</span>payload<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39; </span><span style=color:#e6db74>#{</span>webhook_url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    system(cmd)
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_bus_times</span>()
    today <span style=color:#f92672>=</span> <span style=color:#66d9ef>Date</span><span style=color:#f92672>.</span>today
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#34;Sheraton&#34;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
            <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>local(today<span style=color:#f92672>.</span>year, today<span style=color:#f92672>.</span>month, today<span style=color:#f92672>.</span>day, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>0</span>),
            <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>local(today<span style=color:#f92672>.</span>year, today<span style=color:#f92672>.</span>month, today<span style=color:#f92672>.</span>day, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>0</span>),
            <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>local(today<span style=color:#f92672>.</span>year, today<span style=color:#f92672>.</span>month, today<span style=color:#f92672>.</span>day, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>0</span>)
        <span style=color:#f92672>]</span>,
        <span style=color:#e6db74>&#34;Ericsson&#34;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
            <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>local(today<span style=color:#f92672>.</span>year, today<span style=color:#f92672>.</span>month, today<span style=color:#f92672>.</span>day, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>0</span>),
            <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>local(today<span style=color:#f92672>.</span>year, today<span style=color:#f92672>.</span>month, today<span style=color:#f92672>.</span>day, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>0</span>),
            <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>local(today<span style=color:#f92672>.</span>year, today<span style=color:#f92672>.</span>month, today<span style=color:#f92672>.</span>day, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>00</span>, <span style=color:#ae81ff>0</span>)
        <span style=color:#f92672>]</span>
    }

    <span style=color:#66d9ef>return</span> bus_times
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_next_bus</span>()
    bus_times <span style=color:#f92672>=</span> make_bus_times()
    t <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now
    t2 <span style=color:#f92672>=</span> t <span style=color:#f92672>+</span> <span style=color:#ae81ff>15</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#75715e># 15mins in future</span>
    bus_times<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>key, array<span style=color:#f92672>|</span>
        bus_times<span style=color:#f92672>[</span>key<span style=color:#f92672>].</span>each { <span style=color:#f92672>|</span>val<span style=color:#f92672>|</span>
            <span style=color:#66d9ef>if</span> val<span style=color:#f92672>.</span>between?(t, t2)
                text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;@here Bus leaving from </span><span style=color:#e6db74>#{</span>key<span style=color:#e6db74>}</span><span style=color:#e6db74> in next 15mins at </span><span style=color:#e6db74>#{</span>val<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%H:%M&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
                notify_slack(text)
            <span style=color:#66d9ef>end</span>
        }
    <span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>end</span>

check_next_bus()
</code></pre></div><p>I simply set this to run every 20 minutes, Monday to Friday, during working hours via cron:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>*/20 07-19 * * 1,2,3,4,5 bus-times.rb &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span>
</code></pre></div><p>For convenience, I have the webhook set to post to a different channel so people can opt in for bus reminders.</p></div></div><a href=https://twitter.com/share class=twitter-share-button data-size=small data-count=none>Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');</script><ul class=pager>&nbsp;<li class=previous><a href=../ssh-login-cmd/>Run Command on SSH Login</a></li>&nbsp;<li class=next><a href=../bank-tx-py/>Scraping Data from your Bank in Python</a></li></ul></ul></div><footer><p class="text-muted credit">&copy; 2020. All rights reserved.</p></footer><script src=../js/jquery-1.10.2.min.js></script><script src=../js/bootstrap.min.js></script><script src=../js/bootstrap.js></script><script type=text/javascript src=../js/hc.js></script></body></html>