<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>Ubuntu 20.04 Vagrant with Packer | Neil Grogan</title><link rel=apple-touch-icon sizes=180x180 href=../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../favicon-16x16.png><link rel=icon type=image/png sizes=96x96 href=../favicon-96x96.png><link rel=manifest href=../manifest.json><link rel=mask-icon href=../safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><link rel=stylesheet href=../css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css></head><body><nav><header><div class=site-title><a href=../>Neil Grogan</a></div></header><div class=nav-menu><a class="color-link nav-link" href=../about>About</a>
<a class="color-link nav-link" href=../projects>Projects</a>
<a class="color-link nav-link" href=../presentations/>Presentations</a>
<a class="color-link nav-link" href=../contact>Contact</a>
<a class="color-link nav-link" href=../archives/>Archives</a>
<a class="color-link nav-link" href=../tags/>Tags</a>
<a class="color-link nav-link" href=../index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons></div><script src=../js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin=anonymous></script></footer></nav><div id=content class=content-container><h1 class=post-title>Ubuntu 20.04 Vagrant with Packer</h1><time>May 2, 2020</time><div><p><p>Ubuntu have recently released the new <a href=http://cdimage.ubuntu.com/ubuntu/releases/focal/release/>20.04 LTS codenamed &ldquo;Focal Fossa&rdquo;</a>.
I&rsquo;d also recently seen a tool that piqued my interest, Hashicorp <a href=https://packer.io>Packer</a>. Packer
builds machine images that can be deployed to a cloud or as a virtual machine, or
just even a plain disk image. You can even generate many images at once, really
simplfying deployment. Very handy if you wanted to create virtual machines for a
cluster for example, with a similar but slightly different configuration.</p><p>I decided to take Packer for a spin and try create a virtual machine image for
<a href=https://www.virtualbox.org/>Virtualbox</a>/<a href=https://www.vagrantup.com/>Vagrant</a> that can easily be spun up for any project. Firstly you&rsquo;ll
need to install Virtualbox and then Vagrant on your machine. Next install
Packer.</p><p>Then create directories:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ mkdir ubuntu ubuntu/http ubuntu/output ubuntu/scripts
$ cd ubuntu
</code></pre></div><p><code>http</code> will hold our configuration files for Ubuntu, <code>output</code> will store our
disk image we build and <code>scripts</code> will hold any scripts we want to run.</p><p>Ubuntu 20.04 has a new way to automate installs (they used to use debian preseed
files) - <a href=https://wiki.ubuntu.com/FoundationsTeam/AutomatedServerInstalls>they now use a yaml file</a> (also see their handy <a href=https://wiki.ubuntu.com/FoundationsTeam/AutomatedServerInstalls/QuickStart>quickstart</a> on which I based the below file), so we&rsquo;ll need to create it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ cat &gt; http/user-data <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span><span style=color:#e6db74>#cloud-config
</span><span style=color:#e6db74>autoinstall:
</span><span style=color:#e6db74>    version: 1
</span><span style=color:#e6db74>    locale: en_US
</span><span style=color:#e6db74>    keyboard:
</span><span style=color:#e6db74>      layout: en
</span><span style=color:#e6db74>      variant: uk
</span><span style=color:#e6db74>    identity:
</span><span style=color:#e6db74>      hostname: vagrant
</span><span style=color:#e6db74>      password: &#39;$2y$12$zfS.Dpm682guriw6fJ5PXu4Kv7GSs7VYHUPGphQdSnT0wb4Rt1tVS&#39;
</span><span style=color:#e6db74>      username: vagrant
</span><span style=color:#e6db74>    ssh:
</span><span style=color:#e6db74>      install-server: true
</span><span style=color:#e6db74>EOF</span>
$ touch http/meta-data
</code></pre></div><p>As you can see, we set a hostname, username, password - all the normal things you
would need to set up. We should now have two files - <code>http/user-data</code> containing
our setup information and also <code>http/meta-data</code>.</p><p>Next, we should set up our script(s) - we&rsquo;ll setup just one for now:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ cat &gt; scripts/init.sh <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span><span style=color:#e6db74>#!/bin/bash
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>sudo apt update
</span><span style=color:#e6db74>sudo apt upgrade -y
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Finally, we should set up our Packer configuration file
(<a href=https://www.packer.io/docs/builders/virtualbox-iso.html>config options for virtualbox explained here</a> and
for <a href=https://www.packer.io/docs/builders/vagrant/>vagrant options</a>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>{</span>% raw %<span style=color:#f92672>}</span>
$ cat &gt; ubuntu2004.json <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>    &#34;builders&#34;: [
</span><span style=color:#e6db74>      {
</span><span style=color:#e6db74>        &#34;name&#34;: &#34;ubuntu-2004&#34;,
</span><span style=color:#e6db74>        &#34;type&#34;: &#34;virtualbox-iso&#34;,
</span><span style=color:#e6db74>        &#34;guest_os_type&#34;: &#34;ubuntu-64&#34;,
</span><span style=color:#e6db74>        &#34;headless&#34;: false,
</span><span style=color:#e6db74>  
</span><span style=color:#e6db74>        &#34;iso_url&#34;: &#34;http://releases.ubuntu.com/20.04/ubuntu-20.04-live-server-amd64.iso&#34;,
</span><span style=color:#e6db74>        &#34;iso_checksum&#34;: &#34;caf3fd69c77c439f162e2ba6040e9c320c4ff0d69aad1340a514319a9264df9f&#34;,
</span><span style=color:#e6db74>        &#34;iso_checksum_type&#34;: &#34;sha256&#34;,
</span><span style=color:#e6db74>  
</span><span style=color:#e6db74>        &#34;ssh_username&#34;: &#34;vagrant&#34;,
</span><span style=color:#e6db74>        &#34;ssh_password&#34;: &#34;vagrant&#34;,
</span><span style=color:#e6db74>        &#34;ssh_handshake_attempts&#34;: &#34;20&#34;,
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>        &#34;http_directory&#34;: &#34;http&#34;,
</span><span style=color:#e6db74>        &#34;memory&#34;: 1024,
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>        &#34;boot_wait&#34;: &#34;5s&#34;,
</span><span style=color:#e6db74>        &#34;boot_command&#34;: [
</span><span style=color:#e6db74>          &#34;&lt;enter&gt;&lt;enter&gt;&lt;f6&gt;&lt;esc&gt;&lt;wait&gt; &#34;,
</span><span style=color:#e6db74>          &#34;autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/&#34;,
</span><span style=color:#e6db74>          &#34;&lt;enter&gt;&#34;
</span><span style=color:#e6db74>        ],
</span><span style=color:#e6db74>        &#34;shutdown_command&#34;: &#34;echo &#39;vagrant&#39;|sudo -S shutdown -P now&#34;,
</span><span style=color:#e6db74>        &#34;guest_additions_path&#34;: &#34;VBoxGuestAdditions_{{.Version}}.iso&#34;,
</span><span style=color:#e6db74>        &#34;virtualbox_version_file&#34;: &#34;.vbox_version&#34;,
</span><span style=color:#e6db74>        &#34;vm_name&#34;: &#34;packer-ubuntu-20.04-amd64&#34;,
</span><span style=color:#e6db74>        &#34;vboxmanage&#34;: [
</span><span style=color:#e6db74>        [
</span><span style=color:#e6db74>            &#34;modifyvm&#34;,
</span><span style=color:#e6db74>            &#34;{{.Name}}&#34;,
</span><span style=color:#e6db74>            &#34;--memory&#34;,
</span><span style=color:#e6db74>            &#34;1024&#34;
</span><span style=color:#e6db74>        ],
</span><span style=color:#e6db74>        [
</span><span style=color:#e6db74>            &#34;modifyvm&#34;,
</span><span style=color:#e6db74>            &#34;{{.Name}}&#34;,
</span><span style=color:#e6db74>            &#34;--cpus&#34;,
</span><span style=color:#e6db74>            &#34;1&#34;
</span><span style=color:#e6db74>        ]
</span><span style=color:#e6db74>        ]
</span><span style=color:#e6db74>      }
</span><span style=color:#e6db74>    ],
</span><span style=color:#e6db74>    &#34;provisioners&#34;: [
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>            &#34;type&#34;: &#34;shell&#34;,
</span><span style=color:#e6db74>            &#34;script&#34;: &#34;scripts/init.sh&#34;,
</span><span style=color:#e6db74>            &#34;execute_command&#34;: &#34;echo &#39;vagrant&#39; | {{.Vars}} sudo -S -E bash &#39;{{.Path}}&#39;&#34;
</span><span style=color:#e6db74>        },
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>            &#34;type&#34;: &#34;shell&#34;,
</span><span style=color:#e6db74>            &#34;script&#34;: &#34;scripts/cleanup.sh&#34;,
</span><span style=color:#e6db74>            &#34;execute_command&#34;: &#34;echo &#39;vagrant&#39; | {{.Vars}} sudo -S -E bash &#39;{{.Path}}&#39;&#34;
</span><span style=color:#e6db74>        }    
</span><span style=color:#e6db74>    ],
</span><span style=color:#e6db74>    &#34;post-processors&#34;: [{
</span><span style=color:#e6db74>      &#34;type&#34;: &#34;vagrant&#34;,
</span><span style=color:#e6db74>      &#34;compression_level&#34;: &#34;8&#34;,
</span><span style=color:#e6db74>      &#34;output&#34;: &#34;output/ubuntu-20.04.box&#34;
</span><span style=color:#e6db74>    }]
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>EOF</span>
<span style=color:#f92672>{</span>% endraw %<span style=color:#f92672>}</span> 
</code></pre></div><p>Then we can build the image:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ packer build ubuntu2004.json
</code></pre></div><p>And add it to Vagrant:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ vagrant box add --name ubuntu20.04 output/ubuntu-20.04.box
</code></pre></div><p>Finally, in any other directory, we can create a <code>Vagrantfile</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ cat &gt; Vagrantfile <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span><span style=color:#e6db74># -*- mode: ruby -*-
</span><span style=color:#e6db74># vi: set ft=ruby :
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Vagrant.configure(&#34;2&#34;) do |config|
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>  config.vm.box = &#34;ubuntu20.04&#34;
</span><span style=color:#e6db74>  config.ssh.password = &#34;vagrant&#34;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>  config.vm.network &#34;forwarded_port&#34;, guest: 80, host: 8080
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>  config.vm.provider &#34;virtualbox&#34; do |vb|
</span><span style=color:#e6db74>    # Display the VirtualBox GUI when booting the machine
</span><span style=color:#e6db74>    vb.gui = false
</span><span style=color:#e6db74>  end
</span><span style=color:#e6db74>end
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Then lastly, all we need to do:</p><pre><code>$ vagrant up &amp;&amp; vagrant ssh
</code></pre><p>You should now be in your very own configured machine!</p><p>You can also <a href=https://github.com/dueyfinster/packer/tree/01a97455686fcee1776f5c4d7d32504a6f71b5f8/ubuntu>reference my repository</a> if you get stuck, it has configuration
for Ubuntu 18.04 also.</p></p></div><div class=page-footer><hr class=footer-divider><a class=tag href=../tags/networking>#networking,</a>
<a class=tag href=../tags/homenet>#homenet</a></div></div><footer class=footer-mobile><div class=social-icons></div><script src=../js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin=anonymous></script></footer></body></html>